/*!
 * Synote Media Fragment Player
 *
 * Playing Media Fragment URIs using mediaelementjs player
 *  
 * Copyright 2013 Yunjia Li, University of Southampton (http://www.ecs.soton.ac.uk/people/yl2)
 * Licensed under the MIT License.
 *
 */var MediaFragments=function(d){if(!Array.prototype.forEach)Array.prototype.forEach=function(k,j){if(this===void 0||this===null)throw new TypeError;var b=Object(this),g=b.length>>>0;if(typeof k!=="function")throw new TypeError;for(var m=0;m<g;m++)m in b&&k.call(j,b[m],m,b)};var f=function(k){console.log("Media Fragments URI Parsing Warning: "+k)},q={t:function(k){var j=k.split(",");if(j.length>2)return false;var b=j[0]?j[0]:"";j=j[1]?j[1]:"";if(b===""&&j===""||b&&!j&&k.indexOf(",")!==-1)return false;
var g=/^((npt\:)?((\d+\:(\d\d)\:(\d\d))|((\d\d)\:(\d\d))|(\d+))(\.\d*)?)?$/;if(g.test(b)&&g.test(j)){b=b.replace(/^npt\:/,"");b=b.replace(/\.$/,"");j=j.replace(/\.$/,"");g=function(a){if(a==="")return false;var i,e;a=a.split(":");i=a.length;if(i===3){i=parseInt(a[0],10);e=parseInt(a[1],10);a=parseFloat(a[2])}else if(i===2){i=0;e=parseInt(a[0],10);a=parseFloat(a[1])}else if(i===1){e=i=0;a=parseFloat(a[0])}else return false;if(i>23){f("Please ensure that hours <= 23.");return false}if(e>59){f("Please ensure that minutes <= 59.");
return false}if(a>=60){f("Please ensure that seconds < 60.");return false}return i*3600+e*60+a};var m=g(b),c=g(j);if(b&&j)if(m<c)return{value:k,unit:"npt",start:b,end:j,startNormalized:m,endNormalized:c};else{f("Please ensure that start < end.");return false}else if(g(b)!==false||g(j)!==false)return{value:k,unit:"npt",start:b,end:j,startNormalized:m===false?"":m,endNormalized:c===false?"":c};else{f("Please ensure that start or end are legal.");return false}}g=/^(\d+\:\d\d\:\d\d(\:\d\d(\.\d\d)?)?)?$/;
m=b.replace(/^(smpte(-25|-30|-30-drop)?).*/,"$1");b=b.replace(/^smpte(-25|-30|-30-drop)?\:/,"");if(g.test(b)&&g.test(j)){g=function(a){if(a==="")return false;var i,e,l,n;a=a.split(":");i=a.length;if(i===3){i=parseInt(a[0],10);e=parseInt(a[1],10);l=parseInt(a[2],10);n=a=0}else if(i===4){i=parseInt(a[0],10);e=parseInt(a[1],10);l=parseInt(a[2],10);if(a[3].indexOf(".")===-1){a=parseInt(a[3],10);n=0}else{n=a[3].split(".");a=parseInt(n[0],10);n=parseInt(n[1],10)}}else return false;if(i>23){f("Please ensure that hours <= 23.");
return false}if(e>59){f("Please ensure that minutes <= 59.");return false}if(l>59){f("Please ensure that seconds <= 59.");return false}return i*3600+e*60+l+a*0.0010+n*1.0E-6};if(b&&j)if(g(b)<g(j))return{value:k,unit:m,start:b,end:j};else{f("Please ensure that start < end.");return false}else if(g(b)!==false||g(j)!==false)return{value:k,unit:m,start:b,end:j};else{f("Please ensure that start or end are legal.");return false}}g=/^((\d{4})(-(\d{2})(-(\d{2})(T(\d{2})\:(\d{2})(\:(\d{2})(\.(\d+))?)?(Z|(([-\+])(\d{2})\:(\d{2})))?)?)?)?)?$/;
b=b.replace("clock:","");if(g.test(b)&&g.test(j))if(b&&j&&!isNaN(Date.parse("2009-07-26T11:19:01Z")))if(Date.parse(b)<=Date.parse(j))return{value:k,unit:"clock",start:b,end:j};else{f("Please ensure that start < end.");return false}else return{value:k,unit:"clock",start:b,end:j};f("Invalid time dimension.");return false},xywh:function(k){var j=/^percent\:\d+,\d+,\d+,\d+$/,b=k.replace(/(pixel|percent)\:/,"").split(","),g=b[0],m=b[1],c=b[2];b=b[3];if(/^(pixel\:)?\d+,\d+,\d+,\d+$/.test(k))if(c>0&&b>0)return{value:k,
unit:"pixel",x:g,y:m,w:c,h:b};else{f("Please ensure that w > 0 and h > 0");return false}else{if(j.test(k)){if(function(a,i,e,l){if(!(0<=a&&a<=100)){f("Please ensure that 0 <= x <= 100.");return false}if(!(0<=i&&i<=100)){f("Please ensure that 0 <= y <= 100.");return false}if(!(0<=e&&e<=100)){f("Please ensure that 0 <= w <= 100.");return false}if(!(0<=l&&l<=100)){f("Please ensure that 0 <= h <= 100.");return false}return true}(g,m,c,b))return{value:k,unit:"percent",x:g,y:m,w:c,h:b};f("Invalid percent selection.")}else f("Invalid spatial dimension.");
return false}},track:function(k){return{value:k,name:k}},id:function(k){return{value:k,name:k}},chapter:function(k){return{value:k,chapter:k}}},r=function(k){var j={};k.split("&").forEach(function(b){var g=b.indexOf("=");if(!(g<1)){var m=[b.substring(0,g),b.substring(g+1)];if(m[1]){b=decodeURIComponent(m[0]);g=q[b];m=decodeURIComponent(m[1]);if(g)if(m=g(m)){j[b]||(j[b]=[]);if(b!=="t")j[b].push(m);else j[b][0]=m}}}});return j};return{parse:function(k){return MediaFragments.parseMediaFragmentsUri(k)},
parseMediaFragmentsUri:function(k){k=k?k:d.location.href;var j=k.indexOf("#"),b=k.indexOf("?"),g=j!==-1?j:k.length;b=b!==-1?k.substring(b+1,g):"";k=j!==-1?k.substring(j+1):"";var m=r(b),c=r(k);return{query:m,hash:c,toString:function(){var a=function(i,e){var l="\n["+i+"]:\n";if(!Object.keys)Object.keys=function(n){if(n!==Object(n))throw new TypeError("Object.keys called on non-object");var p=[],o;for(o in n)Object.prototype.hasOwnProperty.call(n,o)&&p.push(o);return p};Object.keys(e).forEach(function(n){l+=
"  * "+n+":\n";e[n].forEach(function(p){l+="    [\n";Object.keys(p).forEach(function(o){l+="      - "+o+": "+p[o]+"\n"});l+="   ]\n"})});return l};return a("Query",m)+a("Hash",c)}}}}}(window),smfplayer=smfplayer||{};smfplayer.version="v0.2";
smfplayer.utils={durationMax:4294967295,audioList:["wma","m4a","mp3","wav","mpeg"],videoList:["mp4","m4v","mov","wmv","flv","ogg","webm"],isYouTubeURL:function(d,f){return d.match(/^https?:\/\/(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/)?f!==true?RegExp.$1:true:false},isDailyMotionURL:function(d){return d.match(/^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/)!==null?true:false},isVimeoURL:function(d){return d.match(/^.+vimeo.com\/(\d+)?/)!==null?true:false},isValidURL:function(d){return/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?(#([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)?$/.test(d)?
true:false},isiPad:function(){return navigator.userAgent.match(/iPad/i)==null?false:true},getTemporalMF:function(d){var f=d.start?d.startNormalized:0;d=d.end?d.endNormalized:durationMax;f=parseFloat(f);d=parseFloat(d);return{st:f,et:d}},getSpatialMF:function(){}};
(function(d,f){function q(a,i){var e=decodeURI(a);e=g[i?"strict":"loose"].exec(e);for(var l={attr:{},param:{},seg:{}},n=14;n--;)l.attr[j[n]]=e[n]||"";l.param.query={};l.param.fragment={};l.attr.query.replace(m,function(p,o,s){if(o)l.param.query[o]=s});l.attr.fragment.replace(c,function(p,o,s){if(o)l.param.fragment[o]=s});l.seg.path=l.attr.path.replace(/^\/+|\/+$/g,"").split("/");l.seg.fragment=l.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");l.attr.base=l.attr.host?l.attr.protocol+"://"+l.attr.host+
(l.attr.port?":"+l.attr.port:""):"";return l}function r(a){a=a.tagName;if(a!==f)return k[a.toLowerCase()];return a}var k={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},j=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],b={anchor:"fragment"},g={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},m=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,c=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;d.fn.url=function(a){var i="";if(this.length)i=d(this).attr(r(this[0]))||"";return d.url(i,a)};d.url=function(a,i){if(arguments.length===1&&a===true){i=true;a=f}i=i||false;a=a||window.location.toString();return{data:q(a,i),attr:function(e){e=
b[e]||e;return e!==f?this.data.attr[e]:this.data.attr},param:function(e){return e!==f?this.data.param.query[e]:this.data.param.query},fparam:function(e){return e!==f?this.data.param.fragment[e]:this.data.param.fragment},segment:function(e){if(e===f)return this.data.seg.path;else{e=e<0?this.data.seg.path.length+e:e-1;return this.data.seg.path[e]}},fsegment:function(e){if(e===f)return this.data.seg.fragment;else{e=e<0?this.data.seg.fragment.length+e:e-1;return this.data.seg.fragment[e]}}}}})(jQuery);
(function(d){var f,q=true,r={width:640,height:480,originalWidth:320,originalHeight:240,isVideo:true,mfAlwaysEnabled:false,spatialEnabled:true,spatialStyle:{},autoStart:true},k={init:function(b){f=this;var g=d.extend({},r,b);if(g.mfURI===undefined){console.error("mfURI cannot be null!");return false}this.pause=function(){d(this).data("smfplayer").smfplayer!==undefined?d(this).data("smfplayer").smfplayer.pause():console.error("smfplayer hasn't been initalised")};this.play=function(){var c=d(this).data("smfplayer").smfplayer;
c!==undefined?c.play():console.error("smfplayer hasn't been initalised")};this.playmf=function(){var c=d(this).data("smfplayer");if(c===undefined)setTimeout(function(){f.playmf()},100);else{var a=0;if(!d.isEmptyObject(c.mfjson.hash))a=smfplayer.utils.getTemporalMF(c.mfjson.hash.t[0]).st;c=d(this).data("smfplayer").smfplayer;this.setPosition(a*1E3);c.media.paused&&c.play();this.mfreplay=true}};this.showxywh=function(c){var a=d(this).data("smfplayer");if(a===undefined)setTimeout(function(){f.showxywh(c)},
100);else if(!(d.isEmptyObject(c)||a.settings.spatialEnabled!==true)){var i;if(a.settings.xywhoverlay===undefined){this.addClass("smfplayer-container");i=d("<div/>");i.css(a.settings.spatialStyle);i.addClass("smfplayer-overlay").appendTo(this);a.settings.xywhoverlay=i}else i=a.settings.xywhoverlay;console.log(c);var e=c.unit;x=c.x;y=c.y;w=c.w;h=c.h;if(e==="percent"){x=Math.floor(x/100*a.settings.width);w=Math.floor(w/100*a.settings.width);y=Math.floor(y/100*a.settings.height);h=Math.floor(h/100*a.settings.height)}i.css({width:w,
height:h,top:y+"px",left:x+"px"});i.show()}};this.hidexywh=function(){var c=d(this).data("smfplayer");if(c===undefined)setTimeout(function(){f.hidexywh()},100);else c.settings.xywhoverlay!==undefined&&c.settings.xywhoverlay.hide()};this.stop=function(){var c=d(this).data("smfplayer").smfplayer;c!==undefined?c.stop():console.error("smfplayer hasn't been initalised")};this.load=function(){var c=d(this).data("smfplayer").smfplayer;c!==undefined?c.load():console.error("smfplayer hasn't been initalised")};
this.getPosition=function(){var c=d(this).data("smfplayer").smfplayer;if(c)return parseInt(c.getCurrentTime()*1E3);else{console.error("smfplayer hasn't been initalised");return-1}};this.setPosition=function(c){var a=d(this).data("smfplayer").smfplayer;c=c?c:0;if(a!==undefined)f.getPosition()<=0?setTimeout(function(){f.setPosition(c)},100):a.setCurrentTime(c/1E3);else console.log("smfplayer hasn't been initalised")};this.getDuration=function(){var c=d(this).data("smfplayer").smfplayer;if(c!==undefined)return c.duration*
1E3;else{console.error("smfplayer hasn't been initalised");return-1}};this.getMFJson=function(){return d(this).data("smfplayer").mfjson};this.getMeplayer=function(){return d(this).data("smfplayer").smfplayer};var m=MediaFragments.parseMediaFragmentsUri(g.mfURI);g.success=function(c,a){if(g.autoStart===true)if(c.pluginType=="flash")c.addEventListener("canplay",function(){c.play();if(d(f).data("smfplayer")===undefined)setTimeout(function(){var l=j(d(f).data("smfplayer").mfjson);f.setPosition(l.st*1E3);
!d.isEmptyObject(l.xywh)&&d(f).data("smfplayer").settings.spatialEnabled===true&&f.showxywh(l.xywh)},100);else{var e=j(d(f).data("smfplayer").mfjson);f.setPosition(e.st*1E3);!d.isEmptyObject(e.xywh)&&d(f).data("smfplayer").settings.spatialEnabled===true&&f.showxywh(e.xywh)}},false);else{c.play();if(d(f).data("smfplayer")===undefined)setTimeout(function(){var e=j(d(f).data("smfplayer").mfjson);f.setPosition(e.st*1E3);!d.isEmptyObject(e.xywh)&&d(f).data("smfplayer").settings.spatialEnabled===true&&
f.showxywh(e.xywh)},100);else{var i=j(d(f).data("smfplayer").mfjson);f.setPosition(i.st*1E3);!d.isEmptyObject(i.xywh)&&d(f).data("smfplayer").settings.spatialEnabled===true&&f.showxywh(i.xywh)}}c.addEventListener("timeupdate",function(){var e=c.currentTime,l=d(f).data("smfplayer");if(l!==undefined){var n=j(l.mfjson),p=n.st,o=n.et;n=n.xywh;if(e<=o&&e>=p){if(l!==undefined)if(!d.isEmptyObject(n)&&l.settings.spatialEnabled===true)if(l.settings.xywhoverlay===undefined||!l.settings.xywhoverlay.is(":visible"))f.showxywh(n)}else l.settings.xywhoverlay!==
undefined&&l.settings.xywhoverlay.is(":visible")&&f.hidexywh();if(g.mfAlwaysEnabled===true)if(o>0)if(e>o){f.setPosition(o*1E3);c.pause()}else{if(e<p){f.setPosition(p*1E3);c.play()}}else{if(e<p){f.setPosition(p*1E3);c.play()}}else if(q===true&&o>0)if(e>o){c.pause();q=false}}},false);if(b.success!==undefined)return b.success.call(this,c,a)};g.error=function(){if(b.error!==undefined)return b.error.call(this)};return this.each(function(){var c=d(this);if(c.data("smfplayer")===undefined){var a=g.mfURI;
if(!d.isEmptyObject(m.hash)){var i=g.mfURI.indexOf("#");a=i!==-1?g.mfURI.substring(0,i):g.mfURI}i=g.isVideo===false?d("<audio/>").prop("width",g.width).prop("height",g.height).prop("preload","auto").appendTo(c):d("<video/>").prop("width",g.width).prop("height",g.height).prop("preload","auto").appendTo(c);a=d("<source/>").prop("src",a).appendTo(i);if(smfplayer.utils.isYouTubeURL(g.mfURI))a.prop("type","video/x-youtube");else if(smfplayer.utils.isDailyMotionURL(g.mfURI))a.prop("type","video/dailymotion");
else if(smfplayer.utils.isVimeoURL(g.mfURI))a.prop("type","video/vimeo");else{var e=d.url(g.mfURI).attr("file").toLowerCase().split(".");if(e.length>1)if(e=e[e.length-1].toLowerCase())if(d.inArray(e,smfplayer.utils.videoList)!=-1)a.attr("type","video/"+e);else d.inArray(e,smfplayer.utils.audioList)!=-1&&a.prop("type","audio/"+e)}g.subtitles!==undefined&&c.initSubtitles(i,g.subtitles);i=new MediaElementPlayer(i.get(0),g);c.data("smfplayer",{target:c,smfplayer:i,settings:g,mfjson:m})}})},destroy:function(){return this.each(function(){var b=
d(this);b.data("smfplayer");d(window).unbind(".smfplayer");b.removeData("smfplayer");b.empty()})}},j=function(b){var g=0,m=smfplayer.utils.durationMax;if(!d.isEmptyObject(b.hash.t)){m=smfplayer.utils.getTemporalMF(b.hash.t[0]);g=m.st;m=m.et}var c={};d.isEmptyObject(b.hash.xywh)||(c=b.hash.xywh[0]);return{st:g,et:m,xywh:c}};d.fn.smfplayer=function(b){if(k[b])return k[b].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof b==="object"||!b)return k.init.apply(this,arguments);else d.error("Method "+
b+" does not exist on jQuery.smfplayer")}})(jQuery);
